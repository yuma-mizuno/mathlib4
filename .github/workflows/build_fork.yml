name: continuous integration (mathlib forks)

on:
  pull_request_target:
    branches-ignore:
      # ignore tmp branches used by bors
      - 'staging.tmp*'
      - 'trying.tmp*'
      - 'staging*.tmp'
      - 'nolints'
    paths-ignore:
      # pull_request_target uses the workflow from the target branch:
      # PR changes under this directory won't affect this run, so
      # running it is just wasteful
      - '.github/workflows/**'

concurrency:
  # label each workflow run; only the latest with each label will run
  # workflows on master get more expressive labels
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  # cancel any running workflow with the same label
  cancel-in-progress: true

# Limit permissions for GITHUB_TOKEN for the entire workflow
permissions:
  contents: read
  pull-requests: write  # Only allow PR comments/labels
  # All other permissions are implicitly 'none'

jobs:
  build:
    name: ci (fork)
    if: ${{ github.event.pull_request.head.repo.fork && github.repository != 'leanprover-community/mathlib4-nightly-testing' }}
    uses: ./.github/workflows/build_template.yml
    with:
      concurrency_group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
      pr_branch_ref: ${{ github.event.pull_request.head.sha }}
      runs_on: pr
    secrets: inherit
